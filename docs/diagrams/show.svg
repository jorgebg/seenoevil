<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="739px" preserveAspectRatio="none" style="width:1048px;height:739px;" version="1.1" viewBox="0 0 1048 739" width="1048px" zoomAndPan="magnify"><defs><filter height="300%" id="f1dnacvq43afx4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="576.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="284" y="132.9316"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="476.0137" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="644" y="162.0645"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="988" y="263.5957"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="988" y="450.9258"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="988" y="572.8125"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="115.0645" style="stroke: #000000; stroke-width: 2.0;" width="677" x="13" y="307.7285"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="114.8867" style="stroke: #000000; stroke-width: 2.0;" width="428" x="609" y="495.0586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="41" x2="41" y1="86.4883" y2="727.5215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="289" x2="289" y1="86.4883" y2="727.5215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="649" x2="649" y1="86.4883" y2="727.5215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="993" x2="993" y1="86.4883" y2="727.5215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="23" y="83.5352">user</text><ellipse cx="41" cy="13" fill="#FEFECE" filter="url(#f1dnacvq43afx4)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M41,21 L41,48 M28,29 L54,29 M41,48 L28,63 M41,48 L54,63 " fill="none" filter="url(#f1dnacvq43afx4)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1dnacvq43afx4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="252" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="259" y="71.5352">browser</text><rect fill="#FEFECE" filter="url(#f1dnacvq43afx4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="619" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="626" y="71.5352">server</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="959" y="83.5352">database</text><path d="M975,34 C975,24 993,24 993,24 C993,24 1011,24 1011,34 L1011,60 C1011,70 993,70 993,70 C993,70 975,70 975,60 L975,34 " fill="#FEFECE" filter="url(#f1dnacvq43afx4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M975,34 C975,44 993,44 993,44 C993,44 1011,44 1011,34 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="576.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="284" y="132.9316"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="476.0137" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="644" y="162.0645"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="988" y="263.5957"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="988" y="450.9258"/><rect fill="#FFFFFF" filter="url(#f1dnacvq43afx4)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="988" y="572.8125"/><polygon fill="#A80036" points="272,128.9316,282,132.9316,272,136.9316,276,132.9316" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="41" x2="278" y1="132.9316" y2="132.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="48" y="113.0566">open shared url</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="48" y="127.8657">/secret/{token}#{client_key}</text><polygon fill="#A80036" points="632,158.0645,642,162.0645,632,166.0645,636,162.0645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="294" x2="638" y1="162.0645" y2="162.0645"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="301" y="156.9985">HTTP GET /secret/{token}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="654" x2="696" y1="191.1973" y2="191.1973"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="696" x2="696" y1="191.1973" y2="204.1973"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="655" x2="696" y1="204.1973" y2="204.1973"/><polygon fill="#A80036" points="665,200.1973,655,204.1973,665,208.1973,661,204.1973" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="661" y="186.1313">id = safe_unserialize(token, server_key)</text><polygon fill="#A80036" points="976,259.5957,986,263.5957,976,267.5957,980,263.5957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="654" x2="982" y1="263.5957" y2="263.5957"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="661" y="228.2642">UPDATE secret</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="661" y="243.397">WHERE id=id AND expiration &lt; now</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="661" y="258.5298">SET reads=reads-1</text><polygon fill="#A80036" points="665,288.7285,655,292.7285,665,296.7285,661,292.7285" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="659" x2="992" y1="292.7285" y2="292.7285"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="671" y="287.6626">updated</text><path d="M13,307.7285 L75,307.7285 L75,314.7285 L65,324.7285 L13,324.7285 L13,307.7285 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="115.0645" style="stroke: #000000; stroke-width: 2.0;" width="677" x="13" y="307.7285"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="28" y="321.2969">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="90" y="320.3633">[</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="94" y="320.0894">if not updated</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="192" y="320.3633">]</text><path d="M258,330.0391 L258,355.0391 L680,355.0391 L680,340.0391 L670,330.0391 L258,330.0391 " fill="#DDDDDD" filter="url(#f1dnacvq43afx4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M670,330.0391 L670,340.0391 L680,340.0391 L670,330.0391 " fill="#DDDDDD" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="354" y="347.6074">secret doesn't exist or has expired</text><polygon fill="#A80036" points="305,381.4824,295,385.4824,305,389.4824,301,385.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="299" x2="643" y1="385.4824" y2="385.4824"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="311" y="380.4165">base.html HTTP 404 Not Found</text><polygon fill="#A80036" points="52,410.793,42,414.793,52,418.793,48,414.793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="46" x2="283" y1="414.793" y2="414.793"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="58" y="410.0508">secret not found</text><polygon fill="#A80036" points="976,446.9258,986,450.9258,976,454.9258,980,450.9258" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="654" x2="982" y1="450.9258" y2="450.9258"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="661" y="445.8599">SELECT * FROM secret WHERE id=id</text><polygon fill="#A80036" points="665,476.0586,655,480.0586,665,484.0586,661,480.0586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="659" x2="992" y1="480.0586" y2="480.0586"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="671" y="474.9927">secret</text><path d="M609,495.0586 L671,495.0586 L671,502.0586 L661,512.0586 L609,512.0586 L609,495.0586 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="114.8867" style="stroke: #000000; stroke-width: 2.0;" width="428" x="609" y="495.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="624" y="508.627">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="686" y="507.6934">[</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="690" y="507.4194">if secret.reads &lt;= 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="830" y="507.6934">]</text><path d="M619,517.3691 L619,542.3691 L1022,542.3691 L1022,527.3691 L1012,517.3691 L619,517.3691 " fill="#DDDDDD" filter="url(#f1dnacvq43afx4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1012,517.3691 L1012,527.3691 L1022,527.3691 L1012,517.3691 " fill="#DDDDDD" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="743" y="534.9375">no more reads allowed</text><polygon fill="#A80036" points="976,568.8125,986,572.8125,976,576.8125,980,572.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="654" x2="982" y1="572.8125" y2="572.8125"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="661" y="567.7466">DELETE FROM secret WHERE id=id</text><polygon fill="#A80036" points="665,597.9453,655,601.9453,665,605.9453,661,601.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="659" x2="992" y1="601.9453" y2="601.9453"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="671" y="596.8794">deleted</text><polygon fill="#A80036" points="305,634.0781,295,638.0781,305,642.0781,301,638.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="299" x2="648" y1="638.0781" y2="638.0781"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="311" y="633.0122">show.html encrypted_data</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="294" x2="336" y1="667.2109" y2="667.2109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="336" x2="336" y1="667.2109" y2="680.2109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="295" x2="336" y1="680.2109" y2="680.2109"/><polygon fill="#A80036" points="305,676.2109,295,680.2109,305,684.2109,301,680.2109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="301" y="662.145">data = decrypt(encrypted_data, client_key)</text><polygon fill="#A80036" points="52,705.5215,42,709.5215,52,713.5215,48,709.5215" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="46" x2="288" y1="709.5215" y2="709.5215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="58" y="704.7793">show</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="95" y="704.4556">data</text><!--
@startuml
hide footbox

actor user
participant browser
participant server
database database

user -> browser ++     : open shared url\n""/secret/{token}#{client_key}""
browser -> server ++   : ""HTTP GET /secret/{token}""
server -> server       : ""id = safe_unserialize(token, server_key)""
server -> database ++  : ""UPDATE secret""\n""WHERE id=id AND expiration < now""\n""SET reads=reads-1""
database - -> server - - : ""updated""

alt ""if not updated""
  note over server, browser #DDDDDD: secret doesn't exist or has expired
  server - -> browser : ""base.html HTTP 404 Not Found""
  browser - -> user   : secret not found
end

server -> database ++  : ""SELECT * FROM secret WHERE id=id""
database - -> server - - : ""secret""

alt ""if secret.reads <= 0""
  note over server, database #DDDDDD: no more reads allowed
  server -> database ++  : ""DELETE FROM secret WHERE id=id""
  database - -> server - - : ""deleted""
end

server - -> browser - - : ""show.html encrypted_data""
browser -> browser    : ""data = decrypt(encrypted_data, client_key)""
browser - -> user   - - : show ""data""

@enduml

PlantUML version 1.2019.05(Sat Apr 20 18:45:36 CEST 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 10.0.2+13
Operating System: Mac OS X
OS Version: 10.14.2
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>